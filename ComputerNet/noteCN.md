<center>计算机网络复习笔记<center/> 

# 一、“在网页上输入网址并显示”到底发生了什么

当我们在浏览器上输入`www.se.ustc.edu.cn`时。

1. 首先要对这个 url 进行域名解析，分析一下域名等级，cn 为我国的一级域名，ustc.edu 为教育机构二级域名，se.ustc.edu 为软件学院这个三级域名，www.se.ustc.edu 为该访问对应的主机。www 开头的域名是一个历史遗留问题，以前需要用 www 来区分于 ftp 这种不能用浏览器访问的服务。

   - DNS 查询报文放置在一个具有 53 号目的端口的 UDP 报文段中；
   - 该 UDP 报文被放入具有源、目的 IP 地址的 IP 数据报中；
   - 客户端将包含 DNS 请求报文的数据报放入一个以太网帧中，发送（在链路层寻址）到局域网网关路由器；
   - 由于只知道网关路由器的 IP 地址，需要通过 ARP 协议获取该网关路由器的 MAC 地址；
   - 此时便可以生成一个具有目的 IP 地址的 ARP 查询报文，将其放置在一个具有广播地址（全F）的以太网帧中，发送给交换机；
   - 网管路由器准备一个包含匹配的 IP 地址的 ARP 回答，指示它的 IP 地址对应的 MAC 地址；
   - 客户端收到 ARP 回答报文的帧，并抽取出网管路由器的 MAC 地址；
   - 至此，客户端可以向交换机发送包含 DNS 查询帧，交换机交付给网关路由器，该帧的目的地址为 DNS 服务器的 IP 地址和网关路由器的 MAC 地址。

   浏览器首先查找浏览器 DNS 缓存（内存）中有没有这个域名的解析，如果没有，依次查询本地 DNS 缓存（内存）、本地 HOST 文件、路由器 DNS 、ISP 的 DNS 服务器，最后查询根域名服务器。当查询根域名服务器时，可以有递归查询（向根域名服务器只要结果）和迭代查询（由根域名服务器至顶级域名服务器，再至权限域名服务器依次查询）两种方式。

   - 路由器收到该帧，抽取 IP 数据报，检查目的地址，并根据其转发表（域内协议 OSPF/RIP + 域间协议 BGP）确定出接口，经过该接口朝着 DNS 服务器转发数据报；
   - 最终包含 DNS 查询的 IP 数据报跳转到 DNS 服务器，抽取 DNS 查询报文，在 DNS 数据库中查找名字`www.se.untc.edu`，找到对应的 IP 地址的 DNS 源记录；
   - DNS 服务器形成一个包含这个主机名到 IP 地址映射的 DNS 回答报文，放入 UDP 报文段寻址回客户端；
   - 客户端从 DNS 报文抽取服务器`www.se.untc.edu`的 IP 地址。

   Linux 中可以用 nslookup 或 dig 来查看域名解析过程。

2. 准备：DHCP、UDP、IP和以太网 --> 再准备：DNS和ARP --> 再准备：域内路由选择到DNS服务器 --> Web客户-服务器交互：TCP和HTTP
   - 客户端为了生成 TCP 套接字，需要与服务器端进行 TCP 三次握手，因此产生一个具有目的端口 80 的 TCP SYN 报文段，将该报文段放置在具有目的 IP 地址（`www.se.untc.edu`）的 IP 数据报中，再放入具有目的 MAC 地址（网管路由器）的帧中，并向交换机发送该帧l；
   - 在局域网、ISP 网络、USTC 网络中路由器朝着`www.se.untc.edu`转发包含 TCP SYN 的数据报，使用每台路由器中的转发表，同上；
   - 包含 TCP SYN 的数据报到达`www.se.untc.edu`主机，从数据报中抽取出 TCP SYN 报文并分解到与端口 80 相联系的欢迎套接字，生成一个连接套接字，产生一个 TCP SYNACK 报文段，将其放入向客户端寻址的一个数据报中，最后放入链路层帧中，发向客户端地址；
   - 包含 TCP SYNACK 报文段的数据到达客户端，进而进入连接状态，准备向服务器端发送字节；
   - 浏览器生成包含要获取 URL 的 HTTP GET 报文，写入套接字，其中 GET　报文成为一个 TCP 报文段的载荷，放入数据报中交付给服务器端；
   - 服务器端收到并返还一个 HTTP 响应报文，将请求的 Web 页内容放入 HTTP 响应体中，并将报文发送进 TCP 套接字中；
   - 客户端收到 HTTP 响应报文，浏览器程序从套接字读取 HTTP 响应，抽取 Web 页面的 HTML，渲染并显示到 Web 页面。